name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install -g marked
      
      - name: Build blog posts
        run: |
          mkdir -p _site/blog
          cp index.html _site/
          
          # Convert each markdown file to HTML
          for md_file in blog/posts/*.md; do
            if [ -f "$md_file" ]; then
              filename=$(basename "$md_file" .md)
              
              # Extract title from markdown
              title=$(grep "^# " "$md_file" | head -1 | sed 's/^# //')
              
              # Extract date (look for *Month Day, Year* pattern)
              date=$(grep "^\*" "$md_file" | head -1 | sed 's/\*//g' | xargs)
              
              # Convert markdown to HTML body
              body=$(marked "$md_file")
              
              # Create full HTML file from template (using double quotes for variable expansion)
              cat > "_site/blog/${filename}.html" << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${title} | PockitCEO</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Courier New', monospace;
                      background: #0a0a0a;
                      color: #e0e0e0;
                      line-height: 1.8;
                      padding: 40px 20px;
                  }
                  .container { max-width: 800px; margin: 0 auto; }
                  .back-link {
                      display: inline-block;
                      color: #1a5490;
                      text-decoration: none;
                      margin-bottom: 40px;
                      font-size: 0.85em;
                      border: 1px solid #1a5490;
                      padding: 6px 12px;
                      transition: all 0.3s ease;
                  }
                  .back-link:hover {
                      background: rgba(26, 84, 144, 0.1);
                  }
                  .post-date {
                      font-size: 0.75em;
                      color: #666;
                      text-transform: uppercase;
                      letter-spacing: 1px;
                      margin-bottom: 10px;
                  }
                  h1 {
                      font-size: 2.5em;
                      color: #e0e0e0;
                      margin-bottom: 20px;
                  }
                  h2 {
                      font-size: 1.5em;
                      color: #e0e0e0;
                      margin: 40px 0 20px;
                      border-bottom: 1px solid #222;
                      padding-bottom: 10px;
                  }
                  p { margin-bottom: 20px; color: #ccc; }
                  code {
                      background: #1a1a1a;
                      padding: 2px 6px;
                      border-radius: 3px;
                      color: #1a5490;
                      font-size: 0.9em;
                  }
                  pre {
                      margin: 20px 0;
                      border: 1px solid #222;
                      border-radius: 4px;
                      overflow-x: auto;
                      background: #0f0f0f !important;
                  }
                  pre code { 
                      background: none; 
                      padding: 0;
                      color: #e0e0e0;
                  }
                  ul, ol { margin: 20px 0 20px 30px; color: #ccc; }
                  li { margin-bottom: 10px; }
                  a { color: #1a5490; text-decoration: none; }
                  a:hover { text-decoration: underline; }
                  strong { color: #e0e0e0; }
                  em { color: #999; font-style: italic; }
                  hr { border: none; border-top: 1px solid #222; margin: 40px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <a href="../index.html" class="back-link">‚Üê Back</a>
                  <article>
                      <div class="post-date">${date}</div>
                      ${body}
                  </article>
              </div>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-solidity.min.js"></script>
          </body>
          </html>
          EOF
              
              echo "Built: ${filename}.html"
            fi
          done
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
